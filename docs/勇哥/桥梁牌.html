<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>桥梁牌</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #F5F5DC;
    }

    #pic {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      margin-top: 25px;
    }

    #pic img {
      object-fit: contain;
      width: 100%;
      height: auto;
    }

    .app {
      width: 700px;
      max-width: 100%;
      margin: 0 auto;
      padding: 12px;
    }

    #table {
      width: 100%;
      border-collapse: collapse;
    }

    tr {
      height: 30px;
    }

    tr:nth-child(even) {
      background-color: transparent;
    }

    tr:not(:last-child) {
      border-bottom: 1px solid rgba(221, 221, 221, 0.5);
    }

    th {
      font-size: 16px;
      font-weight: normal;
      color: #333;
      padding: 0 4px;
      text-align: left;
    }

    th + th {
      border-left: 1px solid rgba(221, 221, 221, 0.5);
    }

    tr th:first-of-type {
      font-weight: bolder;
      width: 68px;
    }

    a[href^='tel'] {
      color: #6cf;
    }

#clock {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 31px;
  position: relative;
}

#clock::before {
  content: "";
  position: absolute;
  top: -5px;
  width: 100%;
  height: 1px;
  background-color: #333;
}

#clock {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-top: 32px;
}

  </style>
</head>

<body>
  <picture id="pic"></picture>
  <div class="app">
    <table id="table"></table>
  </div>
  <div id="clock"></div>

  <script>
    const query = new URLSearchParams(location.search);
    const suffix = (location.pathname.split("/").at(-1) || "").replace(
      /\.html$/i,
      ""
    );
    const id = query.get("id");
    const $pic = document.getElementById("pic");
    $pic.innerHTML =
      [".jpg", ".png", ".jpeg"]
        .map((ext) => suffix + "/" + id + ext)
        .map((src) => `<source srcset="${src}" />`)
        .join("") + "<img>";

    const tags = {
      phone: (phone = '') => `<a href="tel:${phone}">${phone}</a>`,
    };

    const renderItem = (th = '') => {
      th = th || '';
      th = th
        .replace(/\d{4}-\d+/g, tags.phone)
        .replace(/\d{11}/g, tags.phone);
      return `<th>${th}</th>`;
    };

    const formatData = (data) => {
      return data.map((row) => row.map((cell) => cell.replace(/&/g, "<br/>")));
    };

    const main = async () => {
      const $ = document.querySelector.bind(document);
      const $table = $('#table');

      const query = new URLSearchParams(location.search.split('?')[1]);
      const path = `桥梁牌/${query.get('id')}.txt?${Date.now()}`;

      let [[title], ...data] = await fetch(path)
        .then((res) => res.text())
        .catch(() => '')
        .then((str) =>
          str
            .split(/^$/gm)
            .map((it) => it.trim())
            .filter(Boolean)
            .map((it) =>
              it
                .split(/\n|\r/)
                .map((subit) => subit.trim())
                .filter(Boolean),
            ),
        );

      data = formatData(data);

      const maxCount = Math.max(...data.map((it) => it.length));

      $table.innerHTML =
        '<tbody>' +
        data
          .map((rows) =>
            Array.from({ length: maxCount })
              .map((_, i) => renderItem(rows[i]))
              .join(''),
          )
          .map((rowStr) => `<tr>${rowStr}</tr>`)
          .join('') +
        '</tbody>';
    };

    main().catch((err) => {
      console.error(err);
      alert('错误：' + err.message);
    });

    function updateTime() {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const seconds = String(date.getSeconds()).padStart(2, '0');
      const timeString = year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;

      const clockElement = document.getElementById('clock');
      clockElement.textContent = timeString;
    }

    // 初始化，立即显示时间
    updateTime();

    // 每秒更新时间
    setInterval(updateTime, 1000);

  </script>
</body>

</html>